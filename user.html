<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookSwap - Мои обмены</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="user.css">
    <script src="cookie.js"></script>
    <style>
        .logout-btn {
            padding: 8px 20px;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .logout-btn:hover {
            background: #45a049;
        }
        .book-item, .exchange-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .genre-tag {
            display: inline-block;
            background: #f0f0f0;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="images/logo.png" class="logo" alt="BookSwap Logo" onerror="this.src='placeholder-logo.png'">
            <h1>BookSwap</h1>
        </div>
        <div class="auth-fields">
            <p>Добро пожаловать, <span id="username"></span>!</p>
            <a href="#" class="logout-btn" onclick="logout()">Выйти</a>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li><a href="main1-1.html">Главная</a></li>
            <li><a href="book_trade_3.html">Начать обмен</a></li>
            <li><a href="user.html" class="active">Мои обмены</a></li>
            <li><a href="link.html">О нас</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="content-wrapper">
            <aside class="exchange-sidebar">
                <ul>
                    <li><a href="#proposals" onclick="showSection('proposals')">Предложения для обмена</a></li>
                    <li><a href="#want_exchange" onclick="showSection('want_exchange')">Хочу обменять</a></li>
                    <li><a href="#want_receive" onclick="showSection('want_receive')">Хочу получить</a></li>
                    <li><a href="#completed_exchanges" onclick="showSection('completed_exchanges')">Совершённые обмены</a></li>
                    <li><a href="#book_reviews" onclick="showSection('book_reviews')">Отзывы на книги</a></li>
                    <li><a href="#personal_data" onclick="showSection('personal_data')">Личные данные</a></li>
                    <li><a href="#archive" onclick="showSection('archive')">Архив</a></li>
                    <li><a href="#" class="logout-btn" onclick="logout()">Выйти</a></li>
                </ul>
            </aside>

            <div class="exchange-content">
                <!-- Личные данные -->
                <section id="personal_data" class="exchange-section">
                    <h2>Личные данные</h2>
                    <form class="personal-data-form" onsubmit="savePersonalData(event)">
                        <input type="text" placeholder="Имя" name="firstName" id="firstName">
                        <input type="text" placeholder="Фамилия" name="lastName" id="lastName">
                        <input type="text" placeholder="Отчество" name="secondName" id="secondName">
                        <input type="text" placeholder="Страна" name="addCountry" id="addCountry">
                        <input type="text" placeholder="Индекс" name="addrIndex" id="addrIndex">
                        <input type="text" placeholder="Город" name="addrCity" id="addrCity">
                        <input type="text" placeholder="Улица" name="addrStreet" id="addrStreet">
                        <input type="text" placeholder="Дом" name="addrStructure" id="addrStructure">
                        <input type="text" placeholder="Квартира" name="addrApart" id="addrApart">
                        <button type="submit" class="save-btn">Сохранить</button>
                    </form>
                </section>

                <!-- Предложения для обмена -->
                <section id="proposals" class="exchange-section">
                    <h2>Предложения для обмена</h2>
                    <div class="exchange-list" id="proposals-list">
                        <!-- Динамически загружаемые предложения -->
                    </div>
                </section>

                <!-- Хочу обменять -->
                <section id="want_exchange" class="exchange-section">
                    <h2>Хочу обменять</h2>
                    <div class="book-list" id="want-exchange-list">
                        <!-- Динамически загружаемые книги -->
                    </div>
                </section>

                <!-- Хочу получить -->
                <section id="want_receive" class="exchange-section">
                    <h2>Хочу получить</h2>
                    <div class="genre-list" id="wishlist-genres">
                        <p>Данные о желаемых жанрах пока недоступны</p>
                    </div>
                </section>

                <!-- Совершённые обмены -->
                <section id="completed_exchanges" class="exchange-section">
                    <h2>Совершённые обмены</h2>
                    <div class="completed-list" id="completed-exchanges-list">
                        <p>Данные о совершённых обменах пока недоступны</p>
                    </div>
                </section>

                <!-- Отзывы на книги -->
                <section id="book_reviews" class="exchange-section">
                    <h2>Отзывы на книги</h2>
                    <form class="review-form" onsubmit="submitReview(event)">
                        <select name="book" id="book-select" disabled>
                            <option value="">Функциональность пока недоступна</option>
                        </select>
                        <textarea name="review" rows="4" placeholder="Ваш отзыв" disabled></textarea>
                        <button type="submit" disabled>Отправить</button>
                    </form>
                </section>

                <!-- Архив -->
                <section id="archive" class="exchange-section">
                    <h2>Архив</h2>
                    <div class="proposal-list">
                        <div class="proposal-item">
                            <span>Книга 2, Самара</span>
                            <span>Книга 4, Санкт-Петербург</span>
                            <span class="rating">Завершено</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer>
        © BookSwap 2023. Все права защищены.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const username = getCookie('username');
            if (!username) {
                window.location.href = 'login.html';
            } else {
                document.getElementById('username').textContent = username;
                loadPersonalData();
                showSection('proposals');
            }
        });

        async function loadPersonalData() {
            try {
                const response = await fetch(`https://serverbook-1-dhna.onrender.com/api/getUserData?userName=${getCookie('username')}`);
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                const data = await response.json();
                if (data) {
                    document.getElementById('firstName').value = data.firstName || '';
                    document.getElementById('lastName').value = data.lastName || '';
                    document.getElementById('secondName').value = data.secondName || '';
                    document.getElementById('addCountry').value = data.addCountry || '';
                    document.getElementById('addrIndex').value = data.addrIndex || '';
                    document.getElementById('addrCity').value = data.addrCity || '';
                    document.getElementById('addrStreet').value = data.addrStreet || '';
                    document.getElementById('addrStructure').value = data.addrStructure || '';
                    document.getElementById('addrApart').value = data.addrApart || '';
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
            }
        }

        async function savePersonalData(event) {
            event.preventDefault();
            try {
                const response = await fetch('https://serverbook-1-dhna.onrender.com/api/changeUser', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        idUser: getCookie('userId'),
                        ...Object.fromEntries(new FormData(event.target))
                    })
                });
                if (response.ok) alert('Данные сохранены');
                else throw new Error('Ошибка сохранения');
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                alert('Произошла ошибка при сохранении данных');
            }
        }

        async function loadProposals() {
            try {
                const response = await fetch(`https://serverbook-1-dhna.onrender.com/api/getOfferBooks?userName=${getCookie('username')}`);
                if (!response.ok) throw new Error('Ошибка загрузки предложений');
                const offers = await response.json();
                const list = document.getElementById('proposals-list');
                list.innerHTML = offers.map(offer => `
                    <div class="exchange-item">
                        <p>Книга: ${offer.bookName || 'Неизвестно'} 
                        (Автор: ${offer.author || 'Неизвестен'})</p>
                    </div>
                `).join('') || '<p>Предложения отсутствуют</p>';
            } catch (error) {
                console.error('Ошибка загрузки предложений:', error);
                document.getElementById('proposals-list').innerHTML = '<p>Ошибка загрузки</p>';
            }
        }

        async function loadWantExchange() {
            try {
                const response = await fetch(`https://serverbook-1-dhna.onrender.com/api/getOfferBooks?userName=${getCookie('username')}`);
                if (!response.ok) throw new Error('Ошибка загрузки книг');
                const books = await response.json();
                const list = document.getElementById('want-exchange-list');
                list.innerHTML = books.map(book => `
                    <div class="book-item">
                        <h3>${book.bookName || 'Неизвестно'}</h3>
                        <p>Автор: ${book.author || 'Неизвестен'}</p>
                    </div>
                `).join('') || '<p>Книги отсутствуют</p>';
            } catch (error) {
                console.error('Ошибка загрузки книг:', error);
                document.getElementById('want-exchange-list').innerHTML = '<p>Ошибка загрузки</p>';
            }
        }

        function loadWishlist() {
            // Нет доступного маршрута, используем заглушку
            document.getElementById('wishlist-genres').innerHTML = '<p>Данные о желаемых жанрах пока недоступны</p>';
        }

        function loadCompletedExchanges() {
            // Нет доступного маршрута, используем заглушку
            document.getElementById('completed-exchanges-list').innerHTML = '<p>Данные о совершённых обменах пока недоступны</p>';
        }

        function submitReview(event) {
            event.preventDefault();
            alert('Функциональность отзывов пока не реализована');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.exchange-section').forEach(s => s.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';

            if (sectionId === 'proposals') loadProposals();
            if (sectionId === 'want_exchange') loadWantExchange();
            if (sectionId === 'want_receive') loadWishlist();
            if (sectionId === 'completed_exchanges') loadCompletedExchanges();
            // Отзывы не загружаем, так как функциональность отключена
        }

        function logout() {
            document.cookie = 'username=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>