<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookSwap - Мои обмены</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="user.css">
    <script src="cookie.js"></script>
    <style>
        /* Стиль для кнопки "Выйти" */
        .logout-btn {
            padding: 8px 20px;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .logout-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="logo.png" class="logo" alt="BookSwap Logo" onerror="this.src='placeholder-logo.png'">
            <h1>BookSwap</h1>
        </div>
        <div class="auth-fields">
            <p>Добро пожаловать, <span id="username"></span>!</p>
            <a href="#" class="logout-btn" onclick="logout()">Выйти</a>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li><a href="main1-1.html">Главная</a></li>
            <li><a href="book_trade_3.html">Начать обмен</a></li>
            <li><a href="user.html" class="active">Мои обмены</a></li>
            <li><a href="link.html">О нас</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="content-wrapper">
            <aside class="exchange-sidebar">
                <ul>
                    <li><a href="#proposals" onclick="showSection('proposals')">Предложения для обмена</a></li>
                    <li><a href="#want_exchange" onclick="showSection('want_exchange')">Хочу обменять</a></li>
                    <li><a href="#want_receive" onclick="showSection('want_receive')">Хочу получить</a></li>
                    <li><a href="#active_exchanges" onclick="showSection('active_exchanges')">Активные обмены</a></li>
                    <li><a href="#book_reviews" onclick="showSection('book_reviews')">Отзывы на книги</a></li>
                    <li><a href="#personal_data" onclick="showSection('personal_data')">Личные данные</a></li>
                    <li><a href="#archive" onclick="showSection('archive')">Архив</a></li>
                    <li><a href="#" class="logout-btn" onclick="logout()">Выйти</a></li>
                </ul>
            </aside>

            <div class="exchange-content">
                <!-- Раздел: Личные данные -->
                <section id="personal_data" class="exchange-section">
                    <h2>Личные данные</h2>
                    <form class="personal-data-form" onsubmit="savePersonalData(event)">
                        <input type="text" placeholder="Имя" name="firstName" id="firstName">
                        <input type="text" placeholder="Фамилия" name="lastName" id="lastName">
                        <input type="text" placeholder="Отчество" name="secondName" id="secondName">
                        <input type="text" placeholder="Страна" name="addCountry" id="addCountry">
                        <input type="text" placeholder="Индекс" name="addrIndex" id="addrIndex">
                        <input type="text" placeholder="Город" name="addrCity" id="addrCity">
                        <input type="text" placeholder="Улица" name="addrStreet" id="addrStreet">
                        <input type="text" placeholder="Дом" name="addrStructure" id="addrStructure">
                        <input type="text" placeholder="Квартира" name="addrApart" id="addrApart">
                        <button type="submit" class="save-btn">Сохранить</button>
                    </form>
                </section>
                <!-- Остальные разделы остаются без изменений -->
                <section id="proposals" class="exchange-section active">
                    <h2>Предложения для обмена</h2>
                    <div class="proposal-group">
                        <h3>Полное совпадение</h3>
                        <div class="proposal-list">
                            <div class="proposal-item">
                                <span>Золотая рыбка, Самара</span>
                                <span>Веселый перец, Хабаровск</span>
                                <span class="rating">рейтинг 0</span>
                            </div>
                            <div class="proposal-item">
                                <span>Золотая рыбка, Самара</span>
                                <span>Веселый перец, Хабаровск</span>
                                <span class="rating">рейтинг 0</span>
                            </div>
                        </div>
                    </div>
                    <div class="proposal-group">
                        <h3>Частичное совпадение</h3>
                        <div class="proposal-list">
                            <div class="proposal-item">
                                <span>Золотая рыбка, Самара</span>
                                <span>Веселый перец, Хабаровск</span>
                                <span class="rating">рейтинг 0</span>
                            </div>
                        </div>
                    </div>
                    <div class="proposal-group">
                        <h3>Другие интересные предложения</h3>
                        <div class="proposal-list">
                            <div class="proposal-item">
                                <span>Золотая рыбка, Самара</span>
                                <span>Веселый перец, Хабаровск</span>
                                <span class="rating">рейтинг 0</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="want_exchange" class="exchange-section">
                    <h2>Хочу обменять</h2>
                    <div class="book-list">
                        <div class="book-item">
                            <h3>Книга 1</h3>
                            <p>Автор: Автор 1</p>
                        </div>
                        <div class="book-item">
                            <h3>Книга 2</h3>
                            <p>Автор: Автор 2</p>
                        </div>
                    </div>
                </section>

                <section id="want_receive" class="exchange-section">
                    <h2>Хочу получить</h2>
                    <div class="book-list">
                        <div class="book-item">
                            <h3>Книга 3</h3>
                            <p>Автор: Автор 3</p>
                        </div>
                    </div>
                </section>

                <section id="active_exchanges" class="exchange-section">
                    <h2>Активные обмены</h2>
                    <div class="proposal-list">
                        <div class="proposal-item">
                            <span>Книга 1, Самара</span>
                            <span>Книга 3, Москва</span>
                            <span class="rating">В процессе</span>
                        </div>
                    </div>
                </section>

                <section id="book_reviews" class="exchange-section">
                    <h2>Отзывы на книги</h2>
                    <form class="review-form">
                        <select name="book">
                            <option value="">Выберите книгу</option>
                            <option value="book1">Книга 1</option>
                            <option value="book2">Книга 2</option>
                        </select>
                        <textarea name="review" rows="4" placeholder="Ваш отзыв"></textarea>
                        <button type="submit">Отправить</button>
                    </form>
                </section>

                <section id="archive" class="exchange-section">
                    <h2>Архив</h2>
                    <div class="proposal-list">
                        <div class="proposal-item">
                            <span>Книга 2, Самара</span>
                            <span>Книга 4, Санкт-Петербург</span>
                            <span class="rating">Завершено</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer>
        © BookSwap 2023. Все права защищены.
    </footer>

    <script>
        // Функция для установки cookie
        function setCookie(name, value, days) {
            let expires = '';
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = `; expires=${date.toUTCString()}`;
            }
            document.cookie = `${name}=${value || ''}${expires}; path=/`;
        }

        // Проверка авторизации и загрузка данных
        document.addEventListener('DOMContentLoaded', () => {
            const username = getCookie('username');
            if (!username) {
                window.location.href = 'login.html';
            } else {
                document.getElementById('username').textContent = username;
                loadPersonalData(); // Загружаем данные при открытии страницы
            }
        });

        // Функция выхода
        function logout() {
            setCookie('username', '', -1);
            setCookie('userId', '', -1); // Удаляем userId при выходе
            window.location.href = 'login.html';
        }

        // Функция загрузки личных данных
        function loadPersonalData() {
            const userId = getCookie('userId');
            if (!userId) {
                alert('Ошибка: пользователь не идентифицирован');
                window.location.href = 'login.html';
                return;
            }

            fetch(`https://serverbook-1-dhna.onrender.com/api/getUserData?userId=${userId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                return response.json();
            })
            .then(data => {
                if (data) {
                    document.getElementById('firstName').value = data.firstName || '';
                    document.getElementById('lastName').value = data.lastName || '';
                    document.getElementById('secondName').value = data.secondName || '';
                    document.getElementById('addCountry').value = data.addCountry || '';
                    document.getElementById('addrIndex').value = data.addrIndex || '';
                    document.getElementById('addrCity').value = data.addrCity || '';
                    document.getElementById('addrStreet').value = data.addrStreet || '';
                    document.getElementById('addrStructure').value = data.addrStructure || '';
                    document.getElementById('addrApart').value = data.addrApart || '';
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить личные данные');
            });
        }

        // Функция сохранения личных данных
        function savePersonalData(event) {
            event.preventDefault();
            const userId = getCookie('userId');
            if (!userId) {
                alert('Ошибка: пользователь не идентифицирован');
                window.location.href = 'login.html';
                return;
            }

            const personalData = {
                idUser: userId,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                secondName: document.getElementById('secondName').value,
                addCountry: document.getElementById('addCountry').value,
                addrIndex: document.getElementById('addrIndex').value,
                addrCity: document.getElementById('addrCity').value,
                addrStreet: document.getElementById('addrStreet').value,
                addrStructure: document.getElementById('addrStructure').value,
                addrApart: document.getElementById('addrApart').value
            };

            fetch('https://serverbook-1-dhna.onrender.com/api/changeUser', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(personalData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Данные успешно сохранены');
                } else {
                    alert('Ошибка сохранения данных');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при сохранении данных');
            });
        }

        // Функция переключения разделов
        function showSection(sectionId) {
            document.querySelectorAll('.exchange-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            const activeSection = document.getElementById(sectionId);
            activeSection.classList.add('active');
            activeSection.style.display = 'block';
        }

        // Инициализация: показ первого раздела
        document.addEventListener('DOMContentLoaded', () => {
            showSection('proposals');
        });
    </script>
</body>
</html>